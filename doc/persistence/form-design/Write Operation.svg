<svg viewBox="0 0 1800 1000" xmlns="http://www.w3.org/2000/svg">
  
  <text x="550" y="25" font-size="32" font-weight="bold" fill="#d2691e" text-anchor="middle">FORM: Write Operation</text>
  
  
  <rect x="200" y="60" width="740" height="840" fill="none" stroke="#ff0000" stroke-width="3" stroke-dasharray="10,5"/>
  <text x="570" y="55" font-size="14" font-weight="bold" fill="#ff0000" text-anchor="middle">FORM Boundary</text>
  
  
  
  <rect x="50" y="80" width="120" height="60" fill="#ffe4b5" stroke="#ff8c00" stroke-width="2"/>
  <text x="110" y="115" font-size="16" font-weight="bold" text-anchor="middle">PHLEX</text>
  
  
  <rect x="220" y="80" width="140" height="60" fill="#add8e6" stroke="#4682b4" stroke-width="2"/>
  <text x="290" y="110" font-size="14" font-weight="bold" text-anchor="middle">form_interface</text>
  <text x="290" y="128" font-size="12" text-anchor="middle">(form.cpp)</text>
  
  
  <rect x="410" y="80" width="140" height="60" fill="#dda0dd" stroke="#9370db" stroke-width="2"/>
  <text x="480" y="110" font-size="14" font-weight="bold" text-anchor="middle">Persistence</text>
  <text x="480" y="128" font-size="12" text-anchor="middle">(persistence.cpp)</text>
  
  
  <rect x="600" y="80" width="140" height="60" fill="#98fb98" stroke="#228b22" stroke-width="2"/>
  <text x="670" y="110" font-size="14" font-weight="bold" text-anchor="middle">Storage</text>
  <text x="670" y="128" font-size="12" text-anchor="middle">(storage.cpp)</text>
  
 
  <rect x="790" y="80" width="150" height="60" fill="#ffd700" stroke="#b8860b" stroke-width="2"/>
  <text x="865" y="100" font-size="13" font-weight="bold" text-anchor="middle">ROOT Implementation</text>
  <text x="865" y="117" font-size="10" text-anchor="middle">ROOT_TFileImp</text>
  <text x="865" y="132" font-size="10" text-anchor="middle">ROOT_TTreeContainerImp</text>
  
  
  <rect x="990" y="80" width="180" height="60" fill="#d3d3d3" stroke="#808080" stroke-width="2"/>
  <text x="1080" y="100" font-size="14" font-weight="bold" text-anchor="middle">Physical Backend</text>
  <text x="1080" y="117" font-size="11" text-anchor="middle" fill="#666">(External Libraries)</text>
  <text x="1080" y="133" font-size="10" text-anchor="middle" fill="#666">ROOT TTree/RNTuple, HDF5</text>
  
  
  <line x1="110" y1="140" x2="110" y2="920" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="290" y1="140" x2="290" y2="920" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="480" y1="140" x2="480" y2="920" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="670" y1="140" x2="670" y2="920" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="865" y1="140" x2="865" y2="920" stroke="#b8860b" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="1080" y1="140" x2="1080" y2="920" stroke="#999" stroke-width="2" stroke-dasharray="5,5"/>
  
  
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#000"/>
    </marker>
    <marker id="arrowhead-gray" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#666"/>
    </marker>
    <marker id="arrowhead-gold" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#b8860b"/>
    </marker>
  </defs>
  
  
  <rect x="210" y="155" width="710" height="140" fill="#f5f5f5" stroke="#999" stroke-width="1"/>
  <text x="220" y="172" font-size="13" font-weight="bold" fill="#333">Initialization Phase</text>
  
  <line x1="110" y1="185" x2="280" y2="185" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="195" y="180" font-size="11" fill="#000" text-anchor="middle">form_interface(type_map, config)</text>
  
  <line x1="290" y1="205" x2="470" y2="205" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="380" y="200" font-size="11" fill="#000" text-anchor="middle">createPersistence()</text>
  
  <line x1="480" y1="225" x2="660" y2="225" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="570" y="220" font-size="11" fill="#000" text-anchor="middle">createStorage()</text>
  
  <line x1="290" y1="255" x2="470" y2="255" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="380" y="250" font-size="10" fill="#000" text-anchor="middle">configureOutputItems() / configureTechSettings()</text>
  
  
  <rect x="100" y="315" width="20" height="575" fill="#ffe4b5" stroke="#ff8c00" stroke-width="1"/>
  <line x1="110" y1="325" x2="280" y2="325" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="120" y="320" font-size="12" fill="#000">write(creator, product_base/batch)</text>
  
  
  <rect x="280" y="315" width="20" height="575" fill="#add8e6" stroke="#4682b4" stroke-width="1"/>
  <line x1="290" y1="355" x2="285" y2="355" stroke="#4169e1" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="275" y="350" font-size="10" fill="#4169e1" text-anchor="end">findItem(label)</text>
  
  
  <line x1="290" y1="385" x2="470" y2="385" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="300" y="380" font-size="11" fill="#000">createContainers(creator, products)</text>
  
  <rect x="470" y="385" width="20" height="280" fill="#dda0dd" stroke="#9370db" stroke-width="1"/>
  
  
  <line x1="480" y1="405" x2="475" y2="405" stroke="#4169e1" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="465" y="400" font-size="9" fill="#4169e1" text-anchor="end">getPlacement() [findConfigItem, buildFullLabel]</text>
  
  
  <line x1="480" y1="435" x2="660" y2="435" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="490" y="430" font-size="11" fill="#000">createContainers(map&lt;Placement,type&gt;, settings)</text>
  
  <rect x="660" y="435" width="20" height="210" fill="#98fb98" stroke="#228b22" stroke-width="1"/>
  
  
  <line x1="670" y1="455" x2="665" y2="455" stroke="#228b22" stroke-width="1" marker-end="url(#arrowhead)" stroke-dasharray="2,2"/>
  <text x="655" y="450" font-size="9" fill="#228b22" text-anchor="end">m_files.find(fileName)</text>
  
  
  <line x1="670" y1="480" x2="855" y2="480" stroke="#b8860b" stroke-width="2" marker-end="url(#arrowhead-gold)"/>
  <text x="680" y="475" font-size="10" fill="#b8860b">ROOT_TFileImp::create()</text>
  
  <rect x="855" y="480" width="20" height="35" fill="#ffd700" stroke="#b8860b" stroke-width="1"/>
  
  
  <line x1="875" y1="490" x2="1070" y2="490" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="485" font-size="10" fill="#666">TFile::Open("RECREATE")</text>
  
  <rect x="1070" y="490" width="20" height="20" fill="#d3d3d3" stroke="#808080" stroke-width="1"/>
  
  
  <line x1="670" y1="530" x2="855" y2="530" stroke="#b8860b" stroke-width="2" marker-end="url(#arrowhead-gold)"/>
  <text x="680" y="525" font-size="10" fill="#b8860b">file->setAttribute()</text>
  
  <rect x="855" y="530" width="20" height="30" fill="#ffd700" stroke="#b8860b" stroke-width="1"/>
  
  <line x1="875" y1="540" x2="1070" y2="540" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="535" font-size="9" fill="#666">SetCompressionAlgorithm()</text>
  
  
  <line x1="670" y1="575" x2="855" y2="575" stroke="#b8860b" stroke-width="2" marker-end="url(#arrowhead-gold)"/>
  <text x="680" y="570" font-size="10" fill="#b8860b">ROOT_TTreeContainerImp::create()</text>
  
  <rect x="855" y="575" width="20" height="55" fill="#ffd700" stroke="#b8860b" stroke-width="1"/>
  
  <line x1="875" y1="590" x2="1070" y2="590" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="585" font-size="10" fill="#666">new TTree() / RNTuple::Create()</text>
  
  <rect x="1070" y="590" width="20" height="30" fill="#d3d3d3" stroke="#808080" stroke-width="1"/>
  
  
  <line x1="875" y1="620" x2="1070" y2="620" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="615" font-size="9" fill="#666">Branch() / AddField()</text>
  
  
  <line x1="290" y1="685" x2="470" y2="685" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="300" y="680" font-size="11" fill="#000">registerWrite(creator, label, data, type)</text>
  
  <rect x="470" y="685" width="20" height="80" fill="#dda0dd" stroke="#9370db" stroke-width="1"/>
  
  <line x1="480" y1="705" x2="475" y2="705" stroke="#4169e1" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="465" y="700" font-size="9" fill="#4169e1" text-anchor="end">getPlacement(creator, label)</text>
  
  <line x1="480" y1="730" x2="660" y2="730" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="490" y="725" font-size="11" fill="#000">fillContainer(placement, data, type)</text>
  
  <rect x="660" y="730" width="20" height="95" fill="#98fb98" stroke="#228b22" stroke-width="1"/>
  
  
  <line x1="670" y1="750" x2="665" y2="750" stroke="#228b22" stroke-width="1" marker-end="url(#arrowhead)" stroke-dasharray="2,2"/>
  <text x="655" y="745" font-size="9" fill="#228b22" text-anchor="end">m_containers.find({fileName, containerName})</text>
  
  
  <line x1="670" y1="780" x2="855" y2="780" stroke="#b8860b" stroke-width="2" marker-end="url(#arrowhead-gold)"/>
  <text x="680" y="775" font-size="10" fill="#b8860b">container->fill(data)</text>
  
  <rect x="855" y="780" width="20" height="30" fill="#ffd700" stroke="#b8860b" stroke-width="1"/>
  
  <line x1="875" y1="795" x2="1070" y2="795" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="790" font-size="10" fill="#666">TTree->Fill() / RNTuple->Fill()</text>
  
  <rect x="1070" y="795" width="20" height="20" fill="#d3d3d3" stroke="#808080" stroke-width="1"/>
  
  
  <line x1="290" y1="840" x2="470" y2="840" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="300" y="835" font-size="11" fill="#000">commitOutput(creator, id)</text>
  
  <rect x="470" y="840" width="20" height="35" fill="#dda0dd" stroke="#9370db" stroke-width="1"/>
  
  
  <line x1="480" y1="855" x2="475" y2="855" stroke="#4169e1" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="465" y="850" font-size="9" fill="#4169e1" text-anchor="end">getPlacement(creator, "index")</text>
  
  <line x1="480" y1="870" x2="660" y2="870" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="490" y="865" font-size="10" fill="#000">commitContainers(placement)</text>
  
  <rect x="660" y="870" width="20" height="20" fill="#98fb98" stroke="#228b22" stroke-width="1"/>
  
  <line x1="680" y1="880" x2="1070" y2="880" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="690" y="875" font-size="10" fill="#666">TTree->Write() / CommitCluster()</text>
  
  
  <rect x="1320" y="160" width="420" height="200" fill="#fffacd" stroke="#daa520" stroke-width="2"/>
  <text x="1330" y="180" font-size="12" font-weight="bold">Storage Layer Details:</text>
  <text x="1330" y="200" font-size="10">• m_files: map&lt;fileName, Storage_File&gt;</text>
  <text x="1330" y="215" font-size="10">• m_containers: map&lt;{fileName, containerName}, Storage_Container&gt;</text>
  <text x="1330" y="230" font-size="10">• Composite key = (fileName, containerName)</text>
  <text x="1330" y="245" font-size="10">• Files created once, containers reused</text>
  <text x="1330" y="260" font-size="10">• setAttribute() applies tech-specific settings</text>
  <text x="1330" y="275" font-size="10">• setupWrite(type) creates branches/columns</text>
  <text x="1330" y="290" font-size="10">• fill() stages data, commit() writes to disk</text>
  <text x="1330" y="305" font-size="10">• Index container maps ID → entry number</text>
  <text x="1330" y="320" font-size="10">• Mode 'o' = output/write, 'i' = input/read</text>
  <text x="1330" y="335" font-size="10">• NO LOOP: PHLEX calls write() once per event</text>
  <text x="1330" y="350" font-size="10">• FORM processes ONE write request at a time</text>
  
  <rect x="1320" y="380" width="420" height="155" fill="#fff5e6" stroke="#b8860b" stroke-width="2"/>
  <text x="1330" y="400" font-size="11" font-weight="bold" fill="#b8860b">ROOT Implementation Layer (NEW):</text>
  <text x="1330" y="418" font-size="9">• ROOT_TFileImp: Implements IStorage_File interface</text>
  <text x="1330" y="433" font-size="9">  - Wraps ROOT's TFile class</text>
  <text x="1330" y="448" font-size="9">  - Manages file opening, closing, attributes</text>
  <text x="1330" y="463" font-size="9">• ROOT_TTreeContainerImp: Implements IStorage_Container</text>
  <text x="1330" y="478" font-size="9">  - Wraps ROOT's TTree class</text>
  <text x="1330" y="493" font-size="9">  - Handles branch creation, filling, committing</text>
  <text x="1330" y="508" font-size="9">• ROOT_TBranch_ContainerImp: For individual branches</text>
  <text x="1330" y="523" font-size="9">• This layer translates FORM storage calls → ROOT API calls</text>
  
  <rect x="1320" y="555" width="420" height="130" fill="#ffe4e1" stroke="#dc143c" stroke-width="2"/>
  <text x="1330" y="575" font-size="11" font-weight="bold" fill="#8b0000">FORM Boundary:</text>
  <text x="1330" y="593" font-size="9">• Red box shows FORM components</text>
  <text x="1330" y="608" font-size="9">• PHLEX (left) calls FORM, but is separate</text>
  <text x="1330" y="623" font-size="9">• Physical Backend (right) is external ROOT library</text>
  <text x="1330" y="638" font-size="9">• Gold arrows = calls to ROOT implementation layer</text>
  <text x="1330" y="653" font-size="9">• Gray arrows = ROOT implementation calls external library</text>
  <text x="1330" y="668" font-size="9">• FORM = form_interface + Persistence + Storage</text>
  
  <rect x="1320" y="705" width="420" height="100" fill="#f0e68c" stroke="#daa520" stroke-width="2"/>
  <text x="1330" y="725" font-size="11" font-weight="bold">Placement Structure:</text>
  <text x="1330" y="743" font-size="9">• fileName: "toy.root"</text>
  <text x="1330" y="758" font-size="9">• containerName: "Toy_Tracker/trackStart"</text>
  <text x="1330" y="773" font-size="9">  [full_label = creator/label]</text>
  <text x="1330" y="788" font-size="9">• technology: ROOT_TTREE / ROOT_RNTUPLE / HDF5</text>
  
  
  <text x="900" y="970" font-size="11" fill="#666" text-anchor="middle">FORM Write Operation | PHLEX → FORM (form_interface → persistence.cpp → storage.cpp) → ROOT Impl → External (ROOT/HDF5)</text>
</svg>
