<svg viewBox="0 0 1800 950" xmlns="http://www.w3.org/2000/svg">
  
  <text x="550" y="25" font-size="32" font-weight="bold" fill="#d2691e" text-anchor="middle">FORM: Read Operation</text>
  
  
  <rect x="200" y="60" width="740" height="800" fill="none" stroke="#ff0000" stroke-width="3" stroke-dasharray="10,5"/>
  <text x="570" y="55" font-size="14" font-weight="bold" fill="#ff0000" text-anchor="middle">FORM Boundary</text>
  
  
  
  <rect x="50" y="80" width="120" height="60" fill="#ffe4b5" stroke="#ff8c00" stroke-width="2"/>
  <text x="110" y="115" font-size="16" font-weight="bold" text-anchor="middle">PHLEX</text>
  
  
  <rect x="220" y="80" width="140" height="60" fill="#add8e6" stroke="#4682b4" stroke-width="2"/>
  <text x="290" y="110" font-size="14" font-weight="bold" text-anchor="middle">form_interface</text>
  <text x="290" y="128" font-size="12" text-anchor="middle">(form.cpp)</text>
  
  
  <rect x="410" y="80" width="140" height="60" fill="#dda0dd" stroke="#9370db" stroke-width="2"/>
  <text x="480" y="110" font-size="14" font-weight="bold" text-anchor="middle">Persistence</text>
  <text x="480" y="128" font-size="12" text-anchor="middle">(persistence.cpp)</text>
  
  
  <rect x="600" y="80" width="140" height="60" fill="#98fb98" stroke="#228b22" stroke-width="2"/>
  <text x="670" y="110" font-size="14" font-weight="bold" text-anchor="middle">Storage</text>
  <text x="670" y="128" font-size="12" text-anchor="middle">(storage.cpp)</text>
  
  
  <rect x="790" y="80" width="150" height="60" fill="#ffd700" stroke="#b8860b" stroke-width="2"/>
  <text x="865" y="100" font-size="13" font-weight="bold" text-anchor="middle">ROOT Implementation</text>
  <text x="865" y="117" font-size="10" text-anchor="middle">ROOT_TFileImp</text>
  <text x="865" y="132" font-size="10" text-anchor="middle">ROOT_TTreeContainerImp</text>
  
  
  <rect x="990" y="80" width="180" height="60" fill="#d3d3d3" stroke="#808080" stroke-width="2"/>
  <text x="1080" y="100" font-size="14" font-weight="bold" text-anchor="middle">Physical Backend</text>
  <text x="1080" y="117" font-size="11" text-anchor="middle" fill="#666">(External Libraries)</text>
  <text x="1080" y="133" font-size="10" text-anchor="middle" fill="#666">ROOT TTree/RNTuple, HDF5</text>
  
  
  <line x1="110" y1="140" x2="110" y2="880" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="290" y1="140" x2="290" y2="880" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="480" y1="140" x2="480" y2="880" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="670" y1="140" x2="670" y2="880" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="865" y1="140" x2="865" y2="880" stroke="#b8860b" stroke-width="2" stroke-dasharray="5,5"/>
  <line x1="1080" y1="140" x2="1080" y2="880" stroke="#999" stroke-width="2" stroke-dasharray="5,5"/>
  
  
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#000"/>
    </marker>
    <marker id="arrowhead-gray" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#666"/>
    </marker>
    <marker id="arrowhead-gold" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#b8860b"/>
    </marker>
  </defs>
  
  
  <rect x="100" y="165" width="20" height="695" fill="#ffe4b5" stroke="#ff8c00" stroke-width="1"/>
  <line x1="110" y1="175" x2="280" y2="175" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="120" y="170" font-size="12" fill="#000">read(creator, product_base&amp;)</text>
  <text x="120" y="187" font-size="10" fill="#666">[pb: label, id, data*, type]</text>
  
  
  <rect x="280" y="165" width="20" height="695" fill="#add8e6" stroke="#4682b4" stroke-width="1"/>
  <line x1="290" y1="215" x2="285" y2="215" stroke="#4169e1" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="275" y="210" font-size="10" fill="#4169e1" text-anchor="end">findItem(pb.label)</text>
  <text x="275" y="223" font-size="9" fill="#666" text-anchor="end">[O(1) lookup in m_product_to_config]</text>
  
  
  <line x1="290" y1="245" x2="470" y2="245" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="300" y="240" font-size="11" fill="#000">read(creator, label, id, &amp;data, type)</text>
  
  <rect x="470" y="245" width="20" height="600" fill="#dda0dd" stroke="#9370db" stroke-width="1"/>
  
  
  <line x1="480" y1="275" x2="475" y2="275" stroke="#4169e1" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="465" y="270" font-size="10" fill="#4169e1" text-anchor="end">getToken(creator, label, id)</text>
  
  <line x1="480" y1="295" x2="475" y2="295" stroke="#9370db" stroke-width="1" marker-end="url(#arrowhead)" stroke-dasharray="3,2"/>
  <text x="465" y="290" font-size="9" fill="#666" text-anchor="end">findConfigItem(label)</text>
  
  <line x1="480" y1="310" x2="475" y2="310" stroke="#9370db" stroke-width="1" marker-end="url(#arrowhead)" stroke-dasharray="3,2"/>
  <text x="465" y="305" font-size="9" fill="#666" text-anchor="end">buildFullLabel(creator, label) → "creator/label"</text>
  
  
  <line x1="480" y1="340" x2="660" y2="340" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="490" y="335" font-size="11" fill="#000">getIndex(token_index, id, settings)</text>
  
  <rect x="660" y="340" width="20" height="325" fill="#98fb98" stroke="#228b22" stroke-width="1"/>
  
  
  <line x1="670" y1="365" x2="665" y2="365" stroke="#228b22" stroke-width="1" marker-end="url(#arrowhead)" stroke-dasharray="2,2"/>
  <text x="655" y="360" font-size="9" fill="#228b22" text-anchor="end">if (m_indexMaps[containerName].empty())</text>
  
  
  <line x1="670" y1="390" x2="665" y2="390" stroke="#228b22" stroke-width="1" marker-end="url(#arrowhead)" stroke-dasharray="2,2"/>
  <text x="655" y="385" font-size="9" fill="#228b22" text-anchor="end">m_files.find(fileName) → create if missing</text>
  
  
  <line x1="670" y1="415" x2="855" y2="415" stroke="#b8860b" stroke-width="2" marker-end="url(#arrowhead-gold)"/>
  <text x="680" y="410" font-size="10" fill="#b8860b">ROOT_TFileImp::open()</text>
  
  <rect x="855" y="415" width="20" height="30" fill="#ffd700" stroke="#b8860b" stroke-width="1"/>
  
  
  <line x1="875" y1="425" x2="1070" y2="425" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="420" font-size="10" fill="#666">TFile::Open("READ")</text>
  
  <rect x="1070" y="425" width="20" height="20" fill="#d3d3d3" stroke="#808080" stroke-width="1"/>
  
  
  <line x1="670" y1="460" x2="855" y2="460" stroke="#b8860b" stroke-width="2" marker-end="url(#arrowhead-gold)"/>
  <text x="680" y="455" font-size="10" fill="#b8860b">ROOT_TTreeContainerImp::open()</text>
  
  <rect x="855" y="460" width="20" height="60" fill="#ffd700" stroke="#b8860b" stroke-width="1"/>
  
  <line x1="875" y1="475" x2="1070" y2="475" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="470" font-size="10" fill="#666">file->Get("TreeName")</text>
  
  <rect x="1070" y="475" width="20" height="35" fill="#d3d3d3" stroke="#808080" stroke-width="1"/>
  
  <line x1="875" y1="505" x2="1070" y2="505" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="500" font-size="9" fill="#666">SetBranchAddress() / GetBranch()</text>
  
  
  <rect x="660" y="535" width="20" height="115" fill="#e0ffe0" stroke="#228b22" stroke-width="2"/>
  <text x="655" y="555" font-size="10" font-weight="bold" fill="#228b22" text-anchor="end">Build index (first read only):</text>
  <text x="655" y="570" font-size="9" fill="#228b22" text-anchor="end">while(entry++ &lt; nEntries):</text>
  
  
  <line x1="670" y1="590" x2="855" y2="590" stroke="#b8860b" stroke-width="2" marker-end="url(#arrowhead-gold)"/>
  <text x="680" y="585" font-size="9" fill="#b8860b">container->readEntry(entry)</text>
  
  <rect x="855" y="590" width="20" height="30" fill="#ffd700" stroke="#b8860b" stroke-width="1"/>
  
  <line x1="875" y1="600" x2="1070" y2="600" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="595" font-size="9" fill="#666">TTree->GetEntry(entry)</text>
  
  <rect x="1070" y="600" width="20" height="20" fill="#d3d3d3" stroke="#808080" stroke-width="1"/>
  
  <line x1="670" y1="635" x2="665" y2="635" stroke="#228b22" stroke-width="1" marker-end="url(#arrowhead)" stroke-dasharray="2,2"/>
  <text x="655" y="630" font-size="9" fill="#228b22" text-anchor="end">m_indexMaps[containerName][id_string] = entry</text>
  
  
  <line x1="670" y1="655" x2="665" y2="655" stroke="#228b22" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="655" y="650" font-size="10" fill="#228b22" text-anchor="end">rowId = m_indexMaps[containerName][id]</text>
  
  
  <line x1="660" y1="675" x2="480" y2="675" stroke="#228b22" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead)"/>
  <text x="570" y="670" font-size="10" fill="#228b22" text-anchor="middle">return rowId</text>
  
  
  <line x1="480" y1="700" x2="475" y2="700" stroke="#4169e1" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="465" y="695" font-size="10" fill="#4169e1" text-anchor="end">Token{fileName, full_label, tech, rowId}</text>
  
  
  <line x1="480" y1="730" x2="660" y2="730" stroke="#000" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="490" y="725" font-size="11" fill="#000">readContainer(token, &amp;data, type, *settings)</text>
  
  <rect x="660" y="730" width="20" height="110" fill="#98fb98" stroke="#228b22" stroke-width="1"/>
  
  
  <line x1="670" y1="750" x2="665" y2="750" stroke="#228b22" stroke-width="1" marker-end="url(#arrowhead)" stroke-dasharray="2,2"/>
  <text x="655" y="745" font-size="9" fill="#228b22" text-anchor="end">m_containers.find(token.fileName, token.containerName)</text>
  
  
  <line x1="670" y1="780" x2="855" y2="780" stroke="#b8860b" stroke-width="2" marker-end="url(#arrowhead-gold)"/>
  <text x="680" y="775" font-size="10" fill="#b8860b">container->read(rowId)</text>
  
  <rect x="855" y="780" width="20" height="45" fill="#ffd700" stroke="#b8860b" stroke-width="1"/>
  
  <line x1="875" y1="795" x2="1070" y2="795" stroke="#666" stroke-width="2" marker-end="url(#arrowhead-gray)"/>
  <text x="885" y="790" font-size="10" fill="#666">TTree->GetEntry(rowId)</text>
  
  <rect x="1070" y="795" width="20" height="20" fill="#d3d3d3" stroke="#808080" stroke-width="1"/>
  
  <line x1="875" y1="820" x2="865" y2="820" stroke="#b8860b" stroke-width="1" marker-end="url(#arrowhead-gold)" stroke-dasharray="2,2"/>
  <text x="860" y="815" font-size="9" fill="#b8860b" text-anchor="end">copy data to buffer</text>
  
  
  
  <line x1="855" y1="835" x2="670" y2="835" stroke="#b8860b" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead-gold)"/>
  <text x="763" y="830" font-size="9" fill="#b8860b" text-anchor="middle">void* data</text>
  
  
  <line x1="660" y1="845" x2="480" y2="845" stroke="#228b22" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead)"/>
  <text x="570" y="840" font-size="10" fill="#228b22" text-anchor="middle">void* data, type</text>
  
  <line x1="470" y1="855" x2="290" y2="855" stroke="#9370db" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead)"/>
  <text x="380" y="850" font-size="10" fill="#9370db" text-anchor="middle">void</text>
  
  
  <line x1="280" y1="865" x2="110" y2="865" stroke="#4682b4" stroke-width="2" stroke-dasharray="5,3" marker-end="url(#arrowhead)"/>
  <text x="195" y="860" font-size="11" fill="#4682b4" text-anchor="middle">pb.data updated</text>
  <text x="195" y="873" font-size="9" fill="#666" text-anchor="middle">[PHLEX casts: static_cast&lt;T*&gt;(pb.data)]</text>
  
  
  <rect x="1320" y="160" width="420" height="205" fill="#fffacd" stroke="#daa520" stroke-width="2"/>
  <text x="1330" y="180" font-size="12" font-weight="bold">Storage Layer - Read Details:</text>
  <text x="1330" y="200" font-size="10">• m_files: Lazy open on first read</text>
  <text x="1330" y="215" font-size="10">• m_containers: Cached after creation</text>
  <text x="1330" y="230" font-size="10">• m_indexMaps[containerName][id_string] = rowId</text>
  <text x="1330" y="245" font-size="10">• Built once by scanning index container</text>
  <text x="1330" y="260" font-size="10">  - Cached for subsequent reads</text>
  <text x="1330" y="275" font-size="10">• Mode 'i' = input/read mode</text>
  <text x="1330" y="290" font-size="10">• Composite key lookup: (fileName, containerName)</text>
  <text x="1330" y="305" font-size="10">• New memory allocated for each read</text>
  <text x="1330" y="320" font-size="10">• PHLEX responsible for delete</text>
  <text x="1330" y="335" font-size="10">• Type string verified during read</text>
  <text x="1330" y="350" font-size="10">• NO LOOP: PHLEX calls read() once per request</text>
  
  <rect x="1320" y="385" width="420" height="155" fill="#fff5e6" stroke="#b8860b" stroke-width="2"/>
  <text x="1330" y="405" font-size="11" font-weight="bold" fill="#b8860b">ROOT Implementation Layer (NEW):</text>
  <text x="1330" y="423" font-size="9">• ROOT_TFileImp: Implements IStorage_File interface</text>
  <text x="1330" y="438" font-size="9">  - Wraps ROOT's TFile class</text>
  <text x="1330" y="453" font-size="9">  - Manages file opening, mode switching</text>
  <text x="1330" y="468" font-size="9">• ROOT_TTreeContainerImp: Implements IStorage_Container</text>
  <text x="1330" y="483" font-size="9">  - Wraps ROOT's TTree/TBranch classes</text>
  <text x="1330" y="498" font-size="9">  - Handles GetEntry(), SetBranchAddress()</text>
  <text x="1330" y="513" font-size="9">• ROOT_TBranch_ContainerImp: For individual branches</text>
  <text x="1330" y="528" font-size="9">• This layer translates FORM storage calls → ROOT API calls</text>
  
  <rect x="1320" y="560" width="420" height="155" fill="#ffe4e1" stroke="#dc143c" stroke-width="2"/>
  <text x="1330" y="580" font-size="11" font-weight="bold" fill="#8b0000">Two-Step Index Lookup:</text>
  <text x="1330" y="598" font-size="9">Step 1: Build index map (first read only)</text>
  <text x="1330" y="613" font-size="9">• Read all entries from "creator/index" container</text>
  <text x="1330" y="628" font-size="9">• Each entry contains ID string: "[EVENT=00000001|SEG=00000005]"</text>
  <text x="1330" y="643" font-size="9">• Map: m_indexMaps["Toy_Tracker/index"][id_string] = entry_num</text>
  <text x="1330" y="658" font-size="9"> </text>
  <text x="1330" y="673" font-size="9">Step 2: Lookup rowId from ID</text>
  <text x="1330" y="688" font-size="9">• Given semantic ID, get physical entry number</text>
  <text x="1330" y="703" font-size="9">• Use rowId to read actual data container</text>
  
  
  <text x="900" y="930" font-size="11" fill="#666" text-anchor="middle">FORM Read Operation | PHLEX → FORM (form_interface → persistence.cpp → storage.cpp) → ROOT Impl → External (ROOT/HDF5)</text>
</svg>
